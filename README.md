# 百漢中醫 Line 電商網站

[![time tracker](https://wakatime.com/badge/github/Yukaii/bestdoctorcare-shop.svg)](https://wakatime.com/badge/github/Yukaii/bestdoctorcare-shop)

## Development

1. Node.js 環境
1. `npm i -g yarn`
1. `yarn`
1. 設定[環境變數](#Environment-variables)
1. `yarn dev`

## Environment variables

本專案 follow 12-factor 慣例。

先跑 `cp .env.example .env.local`，並填入以下設定：

|                ENV name                 |                                                                                                                                                                                                                                                                                                                                                                              example value                                                                                                                                                                                                                                                                                                                                                                              |                   description                    |                      |
| --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------ | -------------------- |
| `DATABASE_URL`                          | `mysql://root@127.0.0.1:3306/bestdoctorcare_dev?charset=utf8mb4`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | MySQL 資料庫網址                                 |                      |
| `ECPAY_PAYMENT_CONF`                    | `<?xml  version="1.0" encoding="utf-8"?> <Conf> <OperatingMode>Production</OperatingMode> <!--Test or Production--> <MercProfile>Production_Account</MercProfile> <IsProjectContractor>N</IsProjectContractor> <MerchantInfo> <MInfo name="Production_Account"> <MerchantID>111111</MerchantID> <HashKey>************</HashKey> <HashIV>***********</HashIV> </MInfo> <MInfo name="Stage_Account"> <MerchantID>111111</MerchantID> <HashKey>************</HashKey> <HashIV>***********</HashIV> </MInfo> </MerchantInfo> <IgnorePayment> <!-- <Method>Credit</Method> --> <!-- <Method>WebATM</Method> --> <!-- <Method>ATM</Method> --> <!-- <Method>CVS</Method> --> <!-- <Method>BARCODE</Method> --> <!-- <Method>AndroidPay</Method> --> </IgnorePayment> </Conf>` | 綠界設定檔                                       |                      |
| `LINE_CHANNEL_ACCESS_TOKEN`             | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                  | channel access token |
| `LINE_CHANNEL_SECRET`                   | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | channel secret                                   |                      |
| `NEXT_PUBLIC_LIFF_DOMAIN`               | `https://bestdoctorcare-shop-staging.herokuapp.com/`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Liff app url                                     |                      |
| `NEXT_PUBLIC_LIFF_ID`                   | `1654439637-r0vQnP14`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Liff ID                                          |                      |
| `NEXT_PUBLIC_INVITATION_LIFF_DOMAIN`    | `https://bestdoctorcare-shop-staging.herokuapp.com/liff`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | LIFF Domain (deprecated)                         |                      |
| `NEXT_PUBLIC_INVITATION_LIFF_ID`        | `1654439637-QlJvLenq`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | deprecated                                       |                      |
| `NEXT_PUBLIC_SHOPIFY_STORE_FRONT_TOKEN` | `********`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | shopify store front token                        |                      |
| `NEXT_PUBLIC_SHOPIFY_STORE_NAME`        | `tds-dev-store`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                  |                      |
| `NEXT_PUBLIC_RSS`                       | `https://bestdoctorcare.momoka.tw/?feed=rss2`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 最新消息 RSS                                     |                      |
| `NEXT_PUBLIC_FEEDBACK_FORM`             | `https://twsurvey.typeform.com/to/QNlqovpB`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 回饋表單網址                                     |                      |
| `NODE_ENV`                              | `production`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | NODE_ENV，填 production 就好，development 不用填 |                      |
| `SHOPIFY_API_KEY`                       | `xxxxxxx`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Shopify API key                                  |                      |
| `SHOPIFY_APP_PASSWORD`                  | `shppa_*********************`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | shopify app password                             |                      |
| `YOUTUBE_CHANNEL_ID`                    | `UC1esD5N-skqE0JZLpbjvQFA`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                  |                      |
| `YOUTUBE_PLAYLIST_API_KEY`              | `*********************`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                                  |                      |
| `TYPEFORM_SECRET`                       | `*********************`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                                  |                      |

## Deployment

- 跑專案：`yarn build && yarn start`
- 十分鐘一次的 cronjob: `yarn checkOrderStatus`
- Database: MySQL -> 設定 `DATABSE_URL`
- `yarn prisma migrate deploy --preview-feature` 跑 migration
  - `ALTER TABLE Session MODIFY data TEXT;` 手動執行這行 SQL，修改 Session#data 的資料庫欄位型別。
  - 為 Prisma ORM 的開發中功能

## Maintenance scripts

- `yarn setupInvitation`: 建立完 DB 後，為既有的 Shopify 使用者建立 invitation code，理論上 production 會在建立使用者時一起建立，這是維護用保持資料一致的用途
- `yarn task:createRichMenu`: 建立 Line Richmenu。
